# frozen_string_literal: true

module Moderation
  module Detectors
    # HealingExploit raises a moderation ticket when downtime reductions exceed expected thresholds.
    # Usage:
    #   Moderation::Detectors::HealingExploit.new.call(character:, reporter:, delta_seconds:)
    # Returns:
    #   Moderation::Ticket when flagged, nil otherwise.
    class HealingExploit
      MAX_ALLOWED_SHIFT = 10.minutes

      def initialize(report_intake: Moderation::ReportIntake.new)
        @report_intake = report_intake
      end

      def call(character:, reporter:, delta_seconds:)
        return if delta_seconds.abs <= MAX_ALLOWED_SHIFT

        report_intake.call(
          reporter: reporter,
          subject_user: character.user,
          subject_character: character,
          source: :system,
          category: :exploit,
          description: "Detected trauma/healing anomaly (#{delta_seconds}s)",
          priority: :urgent,
          metadata: {
            detector: "healing_exploit",
            delta_seconds: delta_seconds,
            character_id: character.id
          }
        )
      end

      private

      attr_reader :report_intake
    end
  end
end
