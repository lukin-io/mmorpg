<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= content_for(:title) || "Elselands" %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", data: { turbo_track: "reload" } %>
  <%= javascript_importmap_tags %>
</head>
<body class="game-layout" data-controller="game-layout">

  <%# === GAME HEADER === %>
  <header class="game-header" data-game-layout-target="header">
    <div class="header-left">
      <%= link_to root_path, class: "game-logo" do %>
        <%= image_tag "elselands-logo.png", alt: "Elselands", height: 32 %>
      <% end %>

      <% if current_character %>
        <div class="header-character">
          <span class="char-name"><%= current_character.name %></span>
          <span class="char-level">[<%= current_character.level %>]</span>
        </div>

        <%= render "shared/vitals_bar", character: current_character, compact: true %>
      <% end %>
    </div>

    <nav class="header-nav">
      <% if current_character %>
        <%= link_to "Character", "#", class: "header-btn", data: { turbo_frame: "main_content" } %>
        <%= link_to "Inventory", "#", class: "header-btn", data: { turbo_frame: "main_content" } %>
        <%= link_to "Quests", quests_path, class: "header-btn", data: { turbo_frame: "main_content" } %>
        <%= link_to "Map", world_path, class: "header-btn", data: { turbo_frame: "main_content" } %>
      <% end %>
    </nav>

    <div class="header-right">
      <% if user_signed_in? %>
        <%= link_to destroy_user_session_path,
            data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to leave the game?" },
            class: "header-exit" do %>
          <img src="<%= asset_path('exit.png') %>" alt="Exit" width="15" height="15" onerror="this.outerHTML='Exit'">
        <% end %>
      <% end %>
    </div>
  </header>

  <%# === MAIN CONTENT AREA === %>
  <main class="game-main" data-game-layout-target="main">
    <%= turbo_frame_tag "main_content" do %>
      <% if content_for?(:main_content) %>
        <%= yield :main_content %>
      <% else %>
        <%= yield %>
      <% end %>
    <% end %>
  </main>

  <%# === RESIZE HANDLE === %>
  <div class="resize-handle"
       data-game-layout-target="resizeHandle"
       data-action="mousedown->game-layout#startResize">
    <div class="resize-grip">‚ïê‚ïê‚ïê</div>
  </div>

  <%# === BOTTOM PANEL (Chat + Online) === %>
  <footer class="game-bottom" data-game-layout-target="bottom">
    <div class="bottom-content">
      <%# Chat Messages %>
      <div class="bottom-chat"
           data-game-layout-target="chatPanel"
           data-chat-mode="0">
        <%= turbo_frame_tag "chat_panel", src: chat_channels_path, loading: "lazy" do %>
          <div class="loading-placeholder">Loading chat...</div>
        <% end %>
      </div>

      <%# Online Players List %>
      <div class="bottom-online" data-game-layout-target="onlinePanel">
        <%= render "shared/online_players" %>
      </div>
    </div>

    <%# Chat Input Bar %>
    <div class="bottom-input">
      <%= form_with url: chat_messages_path(chat_channel_id: @chat_channel&.id || ChatChannel.global.first&.id),
                    method: :post,
                    class: "chat-input-form",
                    data: {
                      controller: "chat-input",
                      action: "turbo:submit-end->chat-input#reset"
                    } do |f| %>
        <%= f.text_field :body,
            class: "chat-input-field",
            placeholder: "Type a message...",
            autocomplete: "off",
            data: { chat_input_target: "input", action: "keydown->chat-input#handleKeydown" } %>
        <%= f.submit "Send", class: "chat-send-btn" %>
      <% end %>

      <div class="chat-controls">
        <button class="chat-control-btn"
                data-action="click->game-layout#toggleChatMode"
                data-game-layout-target="chatModeBtn"
                title="Chat mode: All messages">
          üí¨
        </button>
        <button class="chat-control-btn"
                data-action="click->game-layout#cycleChatSpeed"
                data-game-layout-target="chatSpeedBtn"
                title="Refresh speed: 10s">
          ‚è±
        </button>
        <button class="chat-control-btn"
                data-action="click->game-layout#toggleClanChat"
                title="Clan chat">
          üè∞
        </button>
        <button class="chat-control-btn"
                data-action="click->game-layout#clearChat"
                title="Clear chat">
          üóë
        </button>
      </div>
    </div>
  </footer>

  <%# Flash messages %>
  <div class="flash-messages">
    <% flash.each do |type, message| %>
      <div class="flash <%= type %>"><%= message %></div>
    <% end %>
  </div>

</body>
</html>

