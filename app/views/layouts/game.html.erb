<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= content_for(:title) || "Elselands" %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", data: { turbo_track: "reload" } %>
  <%= javascript_importmap_tags %>
</head>
<body class="nl-game-layout" data-controller="game-layout">

  <%# === TOP STATUS BAR (like original: name[lv] + HP/MP + text links) === %>
  <header class="nl-top-bar">
    <%# Left: Character name + level + HP/MP bars %>
    <div class="nl-top-left">
      <% if current_character %>
        <a href="<%= profile_path(profile_name: current_character.name) %>" class="nl-player-link">
          <%= current_character.name %></a><span class="nl-player-level">[<%= current_character.level %>]</span>
        <%= render "shared/nl_vitals_bar", character: current_character %>
      <% end %>
    </div>

    <%# Right: Navigation text links (like original) %>
    <nav class="nl-top-nav">
      <% if current_character %>
        <%= link_to "Quests", quests_path, class: "nl-nav-link", data: { turbo_frame: "main_content" } %>
        <%= link_to "Character", profile_path(profile_name: current_character.name), class: "nl-nav-link", data: { turbo_frame: "main_content" } %>
        <%= link_to "Inventory", inventory_path, class: "nl-nav-link", data: { turbo_frame: "main_content" } %>
        <% if @position&.zone&.biome == "city" %>
          <%= link_to "Exit", exit_location_world_path, class: "nl-nav-link", data: { turbo_method: :post } %>
        <% else %>
          <%= link_to "Enter", world_path, class: "nl-nav-link", data: { turbo_frame: "main_content" } %>
        <% end %>
      <% end %>
    </nav>

    <%# Far right: Close button %>
    <div class="nl-top-right">
      <% if user_signed_in? %>
        <%= link_to destroy_user_session_path,
            data: { turbo_method: :delete, turbo_confirm: "Leave game?" },
            class: "nl-close-btn", title: "Exit" do %>✕<% end %>
      <% end %>
    </div>
  </header>

  <%# === MAIN CONTENT AREA (full width, takes most of screen) === %>
  <main class="nl-main-area" data-game-layout-target="mainContent">
    <%= turbo_frame_tag "main_content" do %>
      <% if content_for?(:main_content) %>
        <%= yield :main_content %>
      <% else %>
        <%= yield %>
      <% end %>
    <% end %>

    <%# === FLOATING PLAYERS PANEL (bottom-right corner) === %>
    <aside class="nl-players-float" data-game-layout-target="playersPanel">
      <div class="nl-players-header-float">
        <span class="nl-sort-links">
          Сортировка:
          <a href="#" data-action="click->game-layout#sortPlayers" data-sort="az">a-z</a>
          <a href="#" data-action="click->game-layout#sortPlayers" data-sort="za">z-a</a>
          <a href="#" data-action="click->game-layout#sortPlayers" data-sort="lvl-asc">0-33</a>
          <a href="#" data-action="click->game-layout#sortPlayers" data-sort="lvl-desc">33-0</a>
        </span>
        <label class="nl-refresh-check">
          <input type="checkbox" checked data-action="change->game-layout#toggleAutoRefresh"> обновить
        </label>
      </div>
      <div class="nl-players-location">
        <span class="nl-location-text"><%= @position&.zone&.name || "Unknown" %> [ <%= @players_here&.count || 0 %> ]</span>
        <span class="nl-total-online">Всего [ <%= User.joins(:user_sessions).where(user_sessions: { signed_out_at: nil }).where("user_sessions.last_seen_at > ?", 5.minutes.ago).distinct.count rescue 0 %> ]</span>
      </div>
      <div class="nl-players-list-float" data-game-layout-target="playersList">
        <%= render "shared/nl_players_list" %>
      </div>
    </aside>
  </main>

  <%# === BOTTOM CHAT BAR (small strip at very bottom) === %>
  <footer class="nl-bottom-bar" data-game-layout-target="bottomBar">
    <%# Left: Action buttons %>
    <div class="nl-action-area">
      <button class="nl-action-btn-small" data-action="click->game-layout#showActionMenu">Действие</button>
      <button class="nl-action-btn-small" data-action="click->game-layout#focusChat">Сказать</button>
    </div>

    <%# Center: Chat messages area %>
    <div class="nl-chat-area" data-game-layout-target="chatArea">
      <div class="nl-chat-messages" id="chat-messages" data-game-layout-target="chatMessages">
        <%# Chat messages loaded via Turbo %>
        <% global_chat = ChatChannel.global.first %>
        <%= turbo_frame_tag "chat_messages", src: global_chat ? chat_channel_path(global_chat) : nil, loading: "lazy" do %>
          <div class="nl-chat-loading">Loading...</div>
        <% end %>
      </div>
      <div class="nl-chat-input-bar">
        <% chat_channel = @chat_channel || ChatChannel.global.first %>
        <% if chat_channel %>
          <%= form_with url: chat_channel_chat_messages_path(chat_channel),
                        method: :post,
                        class: "nl-chat-form-inline",
                        data: { controller: "chat-input", action: "turbo:submit-end->chat-input#reset" } do |f| %>
            <%= f.text_field :body,
                class: "nl-chat-input-field",
                placeholder: "Type message...",
                autocomplete: "off",
                data: { chat_input_target: "input", action: "keydown->chat-input#handleKeydown" } %>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# Right: Status icons %>
    <div class="nl-status-icons">
      <span class="nl-time-display"><%= Time.current.strftime("%H:%M:%S") %></span>
    </div>
  </footer>

  <%# Flash messages %>
  <div class="nl-flash-container" id="flash">
    <% flash.each do |type, message| %>
      <div class="nl-flash nl-flash--<%= type %>"><%= message %></div>
    <% end %>
  </div>

  <%# Notification toasts %>
  <div id="notifications" class="nl-notifications" data-game-layout-target="notifications"></div>

</body>
</html>
