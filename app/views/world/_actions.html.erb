<div class="actions-panel">
  <h3>Actions</h3>

  <%# Movement Controls %>
  <% movement_action = available_actions.find { |a| a[:type] == :move } %>
  <% if movement_action %>
    <div class="movement-controls">
      <h4>Move</h4>
      <div class="direction-pad">
        <div class="direction-row">
          <% if movement_action[:directions].include?(:north) %>
            <%= button_to "‚Üë North", move_world_path(direction: :north),
                method: :post, class: "direction-btn direction-btn--north" %>
          <% else %>
            <span class="direction-btn direction-btn--disabled">‚Üë</span>
          <% end %>
        </div>
        <div class="direction-row direction-row--middle">
          <% if movement_action[:directions].include?(:west) %>
            <%= button_to "‚Üê West", move_world_path(direction: :west),
                method: :post, class: "direction-btn direction-btn--west" %>
          <% else %>
            <span class="direction-btn direction-btn--disabled">‚Üê</span>
          <% end %>

          <span class="direction-center">‚óâ</span>

          <% if movement_action[:directions].include?(:east) %>
            <%= button_to "East ‚Üí", move_world_path(direction: :east),
                method: :post, class: "direction-btn direction-btn--east" %>
          <% else %>
            <span class="direction-btn direction-btn--disabled">‚Üí</span>
          <% end %>
        </div>
        <div class="direction-row">
          <% if movement_action[:directions].include?(:south) %>
            <%= button_to "‚Üì South", move_world_path(direction: :south),
                method: :post, class: "direction-btn direction-btn--south" %>
          <% else %>
            <span class="direction-btn direction-btn--disabled">‚Üì</span>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="movement-cooldown">
      <p class="text-muted">Movement on cooldown...</p>
    </div>
  <% end %>

  <%# Location Actions %>
  <div class="location-actions">
    <% exit_action = available_actions.find { |a| a[:type] == :exit } %>
    <% if exit_action %>
      <%= button_to "üö™ #{exit_action[:label]}", exit_location_world_path,
          method: :post, class: "btn-secondary w-full" %>
    <% end %>

    <%# City-specific actions %>
    <% if position.zone.biome == "city" %>
      <div class="city-actions mt-3">
        <h4>City Services</h4>
        <div class="action-grid">
          <%= link_to "üè™ Marketplace", marketplace_kiosks_path, class: "action-btn" %>
          <%= link_to "üèõÔ∏è Auction House", auction_listings_path, class: "action-btn" %>
          <%= link_to "‚öíÔ∏è Crafting", crafting_jobs_path, class: "action-btn" %>
          <%= link_to "üè• Infirmary", "#", class: "action-btn" %>
          <%= link_to "üè¶ Bank", "#", class: "action-btn" %>
          <%= link_to "üìú Quest Board", quests_path, class: "action-btn" %>
        </div>
      </div>
    <% end %>

    <%# Gathering Actions (GatheringNode based - profession required) %>
    <% gather_action = available_actions.find { |a| a[:type] == :gather } %>
    <% if gather_action && gather_action[:nodes].any? %>
      <div class="gather-actions mt-3">
        <h4>Profession Nodes</h4>
        <% gather_action[:nodes].each do |node| %>
          <%= button_to "üåø Gather #{node.resource_key.titleize}",
              gather_world_path(node_id: node.id),
              method: :post, class: "btn-secondary" %>
        <% end %>
      </div>
    <% end %>

    <%# Tile Resource Gathering (biome based - no profession required) %>
    <% tile_resource_action = available_actions.find { |a| a[:type] == :tile_resource } %>
    <% if tile_resource_action && tile_resource_action[:resource] %>
      <% resource = tile_resource_action[:resource] %>
      <div class="tile-resource-actions mt-3">
        <h4>Resources Here</h4>
        <% if resource[:available] %>
          <%= button_to resource_icon(resource[:type]) + " Gather #{resource[:name]}",
              gather_resource_world_path,
              method: :post,
              class: "btn-gather btn-gather--#{resource[:type]}",
              data: { turbo: true } %>
        <% else %>
          <div class="resource-depleted">
            <span class="resource-icon"><%= resource_icon(resource[:type]) %></span>
            <span class="resource-name"><%= resource[:name] %></span>
            <span class="resource-respawn">
              Respawns in <%= format_time_remaining(resource[:respawn_in]) %>
            </span>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Tile NPC (biome-based random spawns) %>
    <% tile_npc_action = available_actions.find { |a| a[:type] == :tile_npc } %>
    <% if tile_npc_action && tile_npc_action[:npc] %>
      <% npc = tile_npc_action[:npc] %>
      <div class="tile-npc-actions mt-3">
        <h4>Creature Here</h4>
        <% if npc[:alive] %>
          <div class="npc-info npc-info--<%= npc[:hostile] ? 'hostile' : 'friendly' %>">
            <div class="npc-header">
              <span class="npc-icon"><%= npc[:hostile] ? 'üëπ' : 'üë§' %></span>
              <span class="npc-name"><%= npc[:name] %></span>
              <span class="npc-level">Lv.<%= npc[:level] %></span>
            </div>
            <% if npc[:hostile] %>
              <div class="npc-hp-bar">
                <div class="npc-hp-fill" style="width: <%= npc[:hp_percentage] %>%"></div>
                <span class="npc-hp-text"><%= npc[:hp] %>/<%= npc[:max_hp] %></span>
              </div>
              <%= form_with url: start_combat_path, method: :post, data: { turbo_frame: "_top" } do |f| %>
                <%= f.hidden_field :npc_template_id, value: npc[:npc_template_id] %>
                <%= f.hidden_field :tile_npc_id, value: npc[:id] %>
                <%= f.submit "‚öîÔ∏è Attack", class: "btn-attack" %>
              <% end %>
            <% else %>
              <p class="npc-description"><%= npc[:description] %></p>
              <%= form_with url: interact_world_path, method: :post, data: { turbo_frame: "_top" } do |f| %>
                <%= f.hidden_field :npc_id, value: npc[:npc_template_id] %>
                <%= f.submit "üí¨ Talk", class: "btn-interact" %>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <div class="npc-defeated">
            <span class="npc-icon">üíÄ</span>
            <span class="npc-name"><%= npc[:name] %></span>
            <span class="npc-respawn">
              Respawns in <%= format_time_remaining(npc[:respawn_in]) %>
            </span>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

