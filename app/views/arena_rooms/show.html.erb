<% content_for :title, "#{@room.name} - Arena" %>

<div class="arena-room-page"
     data-controller="arena"
     data-arena-room-id-value="<%= @room.id %>"
     data-arena-character-id-value="<%= current_character.id %>"
     data-arena-character-level-value="<%= current_character.level %>">

  <div class="page-header">
    <div class="header-left">
      <%= link_to "â¬…ï¸ Back to Arena", arena_index_path, class: "btn-secondary btn-sm" %>
      <h1><%= room_type_badge(@room.room_type) %></h1>
    </div>
    <div class="header-meta">
      <span class="badge">ğŸ“Š Levels <%= @room.level_min %>-<%= @room.level_max %></span>
      <%= arena_room_status_tag(@room) %>
      <% if @room.faction_restriction %>
        <span class="badge badge--faction"><%= faction_icon(@room.faction_restriction) %> <%= @room.faction_restriction.humanize %></span>
      <% end %>
    </div>
  </div>

  <div class="arena-room-layout">
    <%# Left: Application Form %>
    <div class="arena-form-panel" data-arena-target="formContainer">
      <% if @my_application %>
        <div class="arena-current-app card">
          <h3>â³ Your Application</h3>
          <p>
            <strong><%= fight_type_with_icon(@my_application.fight_type) %></strong>
            (<%= fight_kind_with_icon(@my_application.fight_kind) %>)
          </p>
          <p class="application-settings-row">
            <%= application_settings_display(@my_application) %>
          </p>
          <p class="text-muted">
            â° Expires in <%= distance_of_time_in_words_to_now(@my_application.expires_at) %>
          </p>
          <%= button_to "âŒ Cancel",
              arena_room_arena_application_path(@room, @my_application),
              method: :delete,
              class: "btn-danger" %>
        </div>
      <% else %>
        <div class="card">
          <h3>ğŸ“ Submit Application</h3>
          <%= form_with url: arena_room_arena_applications_path(@room),
                        method: :post,
                        class: "arena-form",
                        data: { action: "submit->arena#submitApplication" } do |f| %>

            <div class="arena-form-row">
              <label class="arena-form-label">âš”ï¸ Fight Type</label>
              <%= f.select :fight_type,
                  [["âš”ï¸ Duel (1v1)", "duel"], ["ğŸ‘¥ Team Battle", "team_battle"], ["ğŸ’€ Sacrifice (FFA)", "sacrifice"]],
                  { prompt: "Select fight type" },
                  class: "arena-form-select", required: true %>
            </div>

            <div class="arena-form-row">
              <label class="arena-form-label">ğŸ›¡ï¸ Equipment</label>
              <%= f.select :fight_kind,
                  [
                    ["ğŸ¥Š No Weapons", "no_weapons"],
                    ["ğŸš« No Artifacts", "no_artifacts"],
                    ["âš ï¸ Limited Artifacts", "limited_artifacts"],
                    ["âœ… Free (All Equipment)", "free"]
                  ],
                  { prompt: "Select equipment rules" },
                  class: "arena-form-select", required: true %>
            </div>

            <div class="arena-form-row">
              <label class="arena-form-label">â±ï¸ Timeout</label>
              <%= f.select :timeout_seconds,
                  [["â±ï¸2ï¸âƒ£ 2 min", 120], ["â±ï¸3ï¸âƒ£ 3 min", 180], ["â±ï¸4ï¸âƒ£ 4 min", 240], ["â±ï¸5ï¸âƒ£ 5 min", 300]],
                  { prompt: "Select timeout" },
                  class: "arena-form-select", required: true %>
            </div>

            <div class="arena-form-row">
              <label class="arena-form-label">ğŸ’” Trauma %</label>
              <%= f.select :trauma_percent,
                  [["ğŸ’š Low (10%)", 10], ["ğŸ’› Medium (30%)", 30], ["ğŸ§¡ High (50%)", 50], ["â¤ï¸ Very High (80%)", 80]],
                  { prompt: "Select trauma level" },
                  class: "arena-form-select", required: true %>
            </div>

            <div class="arena-form-row">
              <%= f.submit "ğŸ¯ Submit Application", class: "btn-primary" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Right: Applications List %>
    <div class="arena-applications-panel">
      <div class="card">
        <div class="card-header">
          <h3>ğŸ“‹ Open Applications</h3>
          <span class="badge">ğŸ‘¥ <%= @applications.count %></span>
        </div>

        <div class="arena-applications" data-arena-target="applicationList">
          <% if @applications.empty? %>
            <div class="arena-empty">
              <p>ğŸ” No open applications. Be the first to submit one!</p>
            </div>
          <% else %>
            <% @applications.each do |app| %>
              <div class="arena-application <%= 'arena-application--own' if app.applicant == current_character %>"
                   data-application-id="<%= app.id %>">
                <span class="arena-application-type arena-application-type--<%= app.fight_type %>">
                  <%= fight_type_with_icon(app.fight_type) %>
                </span>

                <div class="arena-application-info">
                  <div class="arena-application-players">
                    <%= character_nameplate(app.applicant, show_level: true) %>
                  </div>
                  <div class="arena-application-details">
                    <%= application_settings_display(app) %>
                  </div>
                </div>

                <span class="arena-application-timer <%= 'arena-application-timer--urgent' if app.time_until_expiration < 60 %>">
                  â° <%= distance_of_time_in_words_to_now(app.expires_at) %>
                </span>

                <div class="arena-application-actions">
                  <% if app.applicant == current_character %>
                    <span class="text-muted">ğŸ‘¤ Your application</span>
                  <% elsif app.acceptable_by?(current_character) %>
                    <%= button_to "âœ… Accept",
                        accept_arena_room_arena_application_path(@room, app),
                        method: :post,
                        class: "btn-primary btn-sm",
                        data: {
                          action: "click->arena#acceptApplication",
                          application_id: app.id
                        } %>
                  <% else %>
                    <span class="text-muted text-sm">ğŸš« Not eligible</span>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Active Matches in this room %>
  <% if @active_matches.any? %>
    <div class="arena-section">
      <h3>ğŸ”´ Active Matches</h3>
      <div class="arena-active-matches">
        <% @active_matches.each do |match| %>
          <div class="arena-match-live">
            <%= arena_match_status_badge(match.status) %>
            <div class="match-participants">
              <% match.arena_participations.group_by(&:team).each_with_index do |(team, participants), idx| %>
                <span class="team team--<%= team %>">
                  <%= participants.map { |p| character_nameplate(p.character, show_level: true) }.join(", ").html_safe %>
                </span>
                <% unless idx == match.arena_participations.group_by(&:team).size - 1 %>
                  <span class="vs">âš”ï¸</span>
                <% end %>
              <% end %>
            </div>
            <%= link_to "ğŸ‘ï¸ Spectate", spectate_arena_match_path(match), class: "btn-secondary btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Countdown overlay %>
  <div class="arena-countdown" data-arena-target="countdown" style="display: none;">
    <div class="arena-countdown-title">Match Starting</div>
    <div class="arena-countdown-timer">--</div>
  </div>
</div>

