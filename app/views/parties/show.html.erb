<%= turbo_stream_from @party %>

<div class="party-detail" data-controller="party" data-party-id-value="<%= @party.id %>">
  <div class="page-header">
    <h1 class="page-title"><%= @party.name %></h1>
    <%= link_to "‚Üê Back to Parties", parties_path, class: "back-link" %>
  </div>

  <div class="party-layout">
    <div class="party-main">
      <div class="party-info-card card">
        <div class="party-status-row">
          <span class="party-status party-status--<%= @party.status %>"><%= @party.status.titleize %></span>
          <span class="party-size"><%= @party.active_members.count %>/<%= @party.max_size %> members</span>
        </div>
        <% if @party.purpose.present? %>
          <p class="party-purpose"><%= @party.purpose %></p>
        <% end %>
      </div>

      <div class="party-members-card card" id="party_members">
        <h2>Members</h2>
        <div class="members-list">
          <% @memberships.active.each do |membership| %>
            <%= render "parties/member", membership: membership, party: @party %>
          <% end %>
        </div>
      </div>

      <% if @party.ready_check_running? %>
        <div class="ready-check-panel card" id="ready_check_panel">
          <h3>üîî Ready Check in Progress</h3>
          <div class="ready-status-grid">
            <% @memberships.active.each do |m| %>
              <div class="ready-member ready-member--<%= m.ready_state %>">
                <span class="member-name"><%= m.user.profile_name %></span>
                <span class="ready-indicator">
                  <% case m.ready_state %>
                  <% when "ready" %>
                    ‚úÖ
                  <% when "not_ready" %>
                    ‚ùå
                  <% else %>
                    ‚è≥
                  <% end %>
                </span>
              </div>
            <% end %>
          </div>
          <% if current_membership&.ready_state == "unknown" %>
            <%= button_to "I'm Ready!", party_party_membership_path(@party, current_membership, ready_state: :ready), method: :patch, class: "game-btn game-btn--success" %>
            <%= button_to "Not Ready", party_party_membership_path(@party, current_membership, ready_state: :not_ready), method: :patch, class: "game-btn game-btn--danger" %>
          <% end %>
        </div>
      <% end %>

      <% if party_leader?(@party) %>
        <% @party_invitation ||= PartyInvitation.new %>

        <div class="pending-invitations card">
          <h3>Invite Player</h3>

          <% if @party_invitation.errors.any? %>
            <div class="alert alert-warning"><%= @party_invitation.errors.full_messages.to_sentence %></div>
          <% end %>

          <%= form_with model: [@party, @party_invitation], url: party_party_invitations_path(@party), class: "party-form" do |form| %>
            <div class="form-group">
              <%= form.label :recipient_id, "Player" %>
              <%= form.collection_select :recipient_id,
                    User.verified.where.not(id: @party.members.select(:id)).order(:profile_name),
                    :id,
                    :profile_name,
                    prompt: "Select player",
                    class: "form-control" %>
            </div>
            <%= form.submit "Send Invite", class: "game-btn game-btn--primary" %>
          <% end %>
        </div>

        <% if @invitations.any? %>
          <div class="pending-invitations card">
            <h3>Pending Invitations</h3>
            <% @invitations.each do |invite| %>
              <div class="invitation-row">
                <span class="invitee-name"><%= invite.recipient.profile_name %></span>
                <span class="text-muted">expires <%= time_ago_in_words(invite.expires_at) %></span>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="party-sidebar">
      <% if party_member?(@party) %>
        <div class="party-actions-card card">
          <h3>Actions</h3>

          <% if party_leader?(@party) %>
            <%= button_to "Start Ready Check", ready_check_party_path(@party), method: :post, class: "game-btn game-btn--primary", disabled: @party.ready_check_running? %>

            <hr>
            <%= button_to "Disband Party", disband_party_path(@party), method: :post, class: "game-btn game-btn--danger", data: { confirm: "Disband this party?" } %>
          <% end %>

          <%= button_to "Leave Party", leave_party_path(@party), method: :post, class: "game-btn game-btn--secondary" %>
        </div>
      <% else %>
        <div class="join-party-card card">
          <h3>Join this Party</h3>
          <p>This party is invite-only. Ask the leader for an invite.</p>
        </div>
      <% end %>

      <div class="party-chat-link card">
        <h3>Party Chat</h3>
        <% if @party.chat_channel.present? %>
          <%= link_to "Open Chat", chat_channel_path(@party.chat_channel), class: "game-btn" %>
        <% end %>
      </div>
    </div>
  </div>
</div>
