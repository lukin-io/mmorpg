<%# Combat Log Viewer - Rich log rendering with statistics %>
<section class="combat-log-viewer"
         data-controller="combat-log"
         data-combat-log-battle-id-value="<%= @battle.id %>"
         data-combat-log-ended-value="<%= @battle_ended %>">

  <%# Header with decorative elements %>
  <div class="combat-log-header">
    <div class="header-decoration left"></div>
    <div class="header-content">
      <h1>‚öîÔ∏è Battle Log #<%= @battle.id %></h1>
      <p class="battle-meta">
        <span class="zone"><%= @battle.zone&.name || "Unknown Zone" %></span>
        <span class="separator">‚Ä¢</span>
        <span class="type"><%= @battle.battle_type.titleize %></span>
        <span class="separator">‚Ä¢</span>
        <span class="rounds">Round <%= @battle.round_number %></span>
        <% if @battle_ended %>
          <span class="separator">‚Ä¢</span>
          <span class="status completed">Battle Ended</span>
        <% else %>
          <span class="separator">‚Ä¢</span>
          <span class="status ongoing">In Progress</span>
        <% end %>
      </p>
    </div>
    <div class="header-decoration right"></div>
  </div>

  <%# View Mode Tabs %>
  <div class="combat-log-tabs">
    <% if @is_public %>
      <%= link_to "üìú Combat Log",
          public_battle_log_path(@battle.share_token, p: 1),
          class: "tab #{@view_mode == :log ? 'active' : ''}" %>
      <%= link_to "üìä Statistics",
          public_battle_log_path(@battle.share_token, stat: 1),
          class: "tab #{@view_mode == :statistics ? 'active' : ''}" %>
    <% else %>
      <%= link_to "üìú Combat Log",
          combat_log_path(@battle, p: 1),
          class: "tab #{@view_mode == :log ? 'active' : ''}" %>
      <%= link_to "üìä Statistics",
          combat_log_path(@battle, stat: 1),
          class: "tab #{@view_mode == :statistics ? 'active' : ''}" %>
    <% end %>
    <div class="tab-spacer"></div>
    <div class="export-buttons">
      <% unless @is_public %>
        <button type="button"
                class="export-btn share-btn"
                data-controller="clipboard"
                data-clipboard-text-value="<%= public_battle_log_url(@battle.share_token) %>"
                data-action="click->clipboard#copy"
                title="Copy shareable link">
          üîó Share
        </button>
      <% end %>
      <% if @is_public %>
        <%= link_to "üìã JSON", public_battle_log_path(@battle.share_token, format: :json), class: "export-btn" %>
      <% else %>
        <%= link_to "üìÑ CSV", combat_log_path(@battle, format: :csv), class: "export-btn" %>
        <%= link_to "üìã JSON", combat_log_path(@battle, format: :json), class: "export-btn" %>
      <% end %>
    </div>
  </div>

  <% if @is_public %>
    <div class="public-notice">
      <span class="notice-icon">üåê</span>
      <span class="notice-text">Public Battle Log ‚Äî Anyone with this link can view</span>
    </div>
  <% end %>

  <% if @view_mode == :statistics %>
    <%# Statistics View %>
    <%= render "statistics" %>
  <% else %>
    <%# Log View %>
    <div class="combat-log-content">
      <%# Filters %>
      <div class="log-filters">
        <%= form_with url: combat_log_path(@battle), method: :get, class: "filter-form", data: {turbo_frame: "_self"} do |f| %>
          <div class="filter-group">
            <%= f.label :filter, "Filter:" %>
            <%= f.select :filter, [["All Events", nil], ["Damage Only", "damage"], ["Healing Only", "healing"]], {}, {onchange: "this.form.submit()"} %>
          </div>
          <div class="filter-group">
            <%= f.label :element, "Element:" %>
            <%= f.select :element, [["All", nil], ["Normal", "normal"], ["Fire", "fire"], ["Water", "water"], ["Earth", "earth"], ["Air", "air"], ["Arcane", "arcane"]], {}, {onchange: "this.form.submit()"} %>
          </div>
          <div class="filter-group">
            <%= f.label :actor_id, "Actor:" %>
            <%= f.select :actor_id, [["All", nil]] + @battle.battle_participants.map { |p| [p.combatant_name, p.id] }, {}, {onchange: "this.form.submit()"} %>
          </div>
        <% end %>
      </div>

      <%# Log Entries %>
      <div class="log-entries" data-combat-log-target="entries">
        <% @combat_log_entries.group_by(&:round_number).each do |round, entries| %>
          <div class="round-group">
            <div class="round-header">Round <%= round %></div>
            <% entries.each do |entry| %>
              <%= render "log_entry", entry: entry %>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Pagination %>
      <% if @total_pages && @total_pages > 1 %>
        <div class="log-pagination">
          <span class="page-label">Pages:</span>
          <% (1..@total_pages).each do |page| %>
            <% if page == @page %>
              <span class="current-page"><%= page %></span>
            <% else %>
              <% if @is_public %>
                <%= link_to page, public_battle_log_path(@battle.share_token, p: page), class: "page-link" %>
              <% else %>
                <%= link_to page, combat_log_path(@battle, p: page, filter: params[:filter], element: params[:element], actor_id: params[:actor_id]), class: "page-link" %>
              <% end %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Participants Panel (shown when battle ongoing) %>
    <% unless @battle_ended %>
      <div class="battle-participants">
        <hr>
        <p class="participants-label">Battle Participants:</p>
        <div class="teams-display">
          <div class="team team-alpha">
            <% @team_alpha.each_with_index do |participant, i| %>
              <span class="participant <%= participant.is_alive ? 'alive' : 'dead' %>">
                <%= participant.combatant_name %>
                <span class="vitals">[<%= participant.current_hp %>/<%= participant.max_hp %>]</span>
              </span><%= i < @team_alpha.length - 1 ? ", " : "" %>
            <% end %>
          </div>
          <span class="vs">vs</span>
          <div class="team team-beta">
            <% @team_beta.each_with_index do |participant, i| %>
              <span class="participant <%= participant.is_alive ? 'alive' : 'dead' %>">
                <%= participant.combatant_name %>
                <span class="vitals">[<%= participant.current_hp %>/<%= participant.max_hp %>]</span>
              </span><%= i < @team_beta.length - 1 ? ", " : "" %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# Footer %>
  <div class="combat-log-footer">
    <div class="footer-decoration left"></div>
    <div class="footer-links">
      <%= link_to "‚Üê Back to Battle", combat_path, class: "footer-link" if @battle.active? %>
      <%= link_to "‚Üê Back to Arena", arena_index_path, class: "footer-link" if @battle.battle_type == "pvp" %>
      <%= link_to "‚Üê Back to World", world_path, class: "footer-link" %>
    </div>
    <div class="footer-decoration right"></div>
  </div>
</section>

