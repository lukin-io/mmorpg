<%= turbo_stream_from @trade_session %>

<div class="trade-session" data-controller="trade" data-trade-session-id-value="<%= @trade_session.id %>">
  <div class="page-header">
    <h1 class="page-title">Trading with <%= trade_partner(@trade_session).profile_name %></h1>
  </div>

  <div class="trade-layout">
    <div class="trade-side trade-side--you">
      <h2>Your Offer</h2>

      <div class="trade-items" id="your_trade_items">
        <% your_items = @trade_items.select { |i| i.owner == current_user } %>
        <% if your_items.any? %>
          <% your_items.each do |item| %>
            <%= render "trade_sessions/trade_item", item: item, can_remove: !@trade_session.locked? %>
          <% end %>
        <% else %>
          <p class="no-items">No items added yet</p>
        <% end %>
      </div>

      <% unless @trade_session.locked? %>
        <div class="add-item-form card">
          <%= form_with model: [@trade_session, @trade_item], url: trade_session_trade_items_path(@trade_session), class: "trade-item-form" do |f| %>
            <div class="form-group">
              <%= f.label :item_key, "Add Item" %>
              <%= f.select :item_key, inventory_items_for_select(current_user), { include_blank: "Select item..." }, class: "form-control" %>
            </div>

            <div class="form-row">
              <div class="form-group">
                <%= f.label :quantity %>
                <%= f.number_field :quantity, class: "form-control", min: 1, value: 1 %>
              </div>
            </div>

            <%= f.submit "Add to Trade", class: "game-btn game-btn--primary" %>
          <% end %>
        </div>

        <div class="add-currency-form card">
          <h4>Add Currency</h4>
          <%= form_with model: [@trade_session, @trade_item], url: trade_session_trade_items_path(@trade_session), class: "currency-form" do |f| %>
            <%= f.hidden_field :item_type, value: "currency" %>

            <div class="form-group">
              <%= f.label :currency_type %>
              <%= f.select :currency_type, [["Gold", "gold"], ["Silver", "silver"]], {}, class: "form-control" %>
            </div>

            <div class="form-group">
              <%= f.label :amount %>
              <%= f.number_field :amount, class: "form-control", min: 1 %>
            </div>

            <%= f.submit "Add Currency", class: "game-btn" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="trade-divider">
      <div class="trade-arrows">⇄</div>
    </div>

    <div class="trade-side trade-side--partner">
      <h2><%= trade_partner(@trade_session).profile_name %>'s Offer</h2>

      <div class="trade-items" id="partner_trade_items">
        <% partner_items = @trade_items.reject { |i| i.owner == current_user } %>
        <% if partner_items.any? %>
          <% partner_items.each do |item| %>
            <%= render "trade_sessions/trade_item", item: item, can_remove: false %>
          <% end %>
        <% else %>
          <p class="no-items">No items added yet</p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="trade-summary card">
    <h3>Trade Summary</h3>

    <div class="summary-content">
      <div class="summary-column">
        <h4>You Give:</h4>
        <ul>
          <% @preview[:you_give].each do |item| %>
            <li><%= item[:name] %> <% if item[:quantity] > 1 %>x<%= item[:quantity] %><% end %></li>
          <% end %>
        </ul>
        <% if @preview[:you_give_currency].present? %>
          <p class="currency-total"><%= @preview[:you_give_currency] %></p>
        <% end %>
      </div>

      <div class="summary-column">
        <h4>You Receive:</h4>
        <ul>
          <% @preview[:you_receive].each do |item| %>
            <li><%= item[:name] %> <% if item[:quantity] > 1 %>x<%= item[:quantity] %><% end %></li>
          <% end %>
        </ul>
        <% if @preview[:you_receive_currency].present? %>
          <p class="currency-total"><%= @preview[:you_receive_currency] %></p>
        <% end %>
      </div>
    </div>

    <% if @preview[:warnings].any? %>
      <div class="trade-warnings">
        <% @preview[:warnings].each do |warning| %>
          <p class="warning">⚠️ <%= warning %></p>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="trade-actions">
    <% if @trade_session.status == "pending" %>
      <% if trade_confirmed_by_you?(@trade_session) %>
        <p class="waiting-notice">Waiting for <%= trade_partner(@trade_session).profile_name %> to confirm...</p>
      <% else %>
        <%= button_to "Confirm Trade", trade_session_path(@trade_session, confirm: true), method: :patch, class: "game-btn game-btn--success", data: { confirm: "Are you sure you want to confirm this trade?" } %>
      <% end %>

      <%= button_to "Cancel Trade", trade_session_path(@trade_session, cancel: true), method: :patch, class: "game-btn game-btn--danger" %>
    <% elsif @trade_session.status == "completed" %>
      <p class="trade-complete">✅ Trade completed successfully!</p>
      <%= link_to "Back to Game", root_path, class: "game-btn" %>
    <% elsif @trade_session.status == "cancelled" %>
      <p class="trade-cancelled">❌ Trade was cancelled.</p>
      <%= link_to "Back to Game", root_path, class: "game-btn" %>
    <% end %>
  </div>
</div>
