<%= turbo_stream_from @trade_session %>

<div class="trade-session" data-controller="trade" data-trade-session-id-value="<%= @trade_session.id %>">
  <div class="page-header">
    <h1 class="page-title">Trading with <%= trade_partner(@trade_session).profile_name %></h1>
  </div>

  <div class="trade-layout">
    <div class="trade-side trade-side--you">
      <h2>Your Offer</h2>

      <div class="trade-items" id="your_trade_items">
        <% your_items = @trade_items.select { |i| i.owner == current_user } %>
        <% if your_items.any? %>
          <% your_items.each do |item| %>
            <%= render "trade_sessions/trade_item", item: item, can_remove: !@trade_session.locked? %>
          <% end %>
        <% else %>
          <p class="no-items">No items added yet</p>
        <% end %>
      </div>

      <% unless @trade_session.locked? %>
        <div class="add-item-form card">
          <%= form_with model: [@trade_session, @trade_item], url: trade_session_trade_items_path(@trade_session), class: "trade-item-form" do |f| %>
            <div class="form-group">
              <%= f.label :item_name, "Add Item" %>
              <%= f.select :item_name, inventory_items_for_select(current_user), { include_blank: "Select item..." }, class: "form-control" %>
            </div>

            <div class="form-row">
              <div class="form-group">
                <%= f.label :quantity %>
                <%= f.number_field :quantity, class: "form-control", min: 1, value: 1 %>
              </div>
            </div>

            <%= f.submit "Add to Trade", class: "game-btn game-btn--primary" %>
          <% end %>
        </div>

        <div class="add-currency-form card">
          <h4>Add Currency</h4>
          <%= form_with model: [@trade_session, @trade_item], url: trade_session_trade_items_path(@trade_session), class: "currency-form" do |f| %>
            <div class="form-group">
              <%= f.label :currency_type %>
              <%= f.select :currency_type, [["Gold", "gold"], ["Silver", "silver"]], {}, class: "form-control" %>
            </div>

            <div class="form-group">
              <%= f.label :currency_amount, "Amount" %>
              <%= f.number_field :currency_amount, class: "form-control", min: 1 %>
            </div>

            <%= f.submit "Add Currency", class: "game-btn" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="trade-divider">
      <div class="trade-arrows">â‡„</div>
    </div>

    <div class="trade-side trade-side--partner">
      <h2><%= trade_partner(@trade_session).profile_name %>'s Offer</h2>

      <div class="trade-items" id="partner_trade_items">
        <% partner_items = @trade_items.reject { |i| i.owner == current_user } %>
        <% if partner_items.any? %>
          <% partner_items.each do |item| %>
            <%= render "trade_sessions/trade_item", item: item, can_remove: false %>
          <% end %>
        <% else %>
          <p class="no-items">No items added yet</p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="trade-summary card">
    <h3>Trade Summary</h3>

    <%
      you_totals, partner_totals =
        if @trade_session.initiator == current_user
          [@preview.initiator_totals, @preview.recipient_totals]
        else
          [@preview.recipient_totals, @preview.initiator_totals]
        end
    %>

    <div class="summary-content">
      <div class="summary-column">
        <h4>You Give:</h4>
        <ul>
          <% you_totals[:items].each do |item| %>
            <li><%= item.item_name %> <% if item.quantity > 1 %>x<%= item.quantity %><% end %></li>
          <% end %>
        </ul>
        <% if you_totals[:gold].to_i.positive? %>
          <p class="currency-total">ğŸª™ <%= you_totals[:gold] %> Gold</p>
        <% end %>
        <% if you_totals[:silver].to_i.positive? %>
          <p class="currency-total">ğŸ¥ˆ <%= you_totals[:silver] %> Silver</p>
        <% end %>
        <% if you_totals[:premium_tokens].to_i.positive? %>
          <p class="currency-total">â­ <%= you_totals[:premium_tokens] %> Premium Tokens</p>
        <% end %>
      </div>

      <div class="summary-column">
        <h4>You Receive:</h4>
        <ul>
          <% partner_totals[:items].each do |item| %>
            <li><%= item.item_name %> <% if item.quantity > 1 %>x<%= item.quantity %><% end %></li>
          <% end %>
        </ul>
        <% if partner_totals[:gold].to_i.positive? %>
          <p class="currency-total">ğŸª™ <%= partner_totals[:gold] %> Gold</p>
        <% end %>
        <% if partner_totals[:silver].to_i.positive? %>
          <p class="currency-total">ğŸ¥ˆ <%= partner_totals[:silver] %> Silver</p>
        <% end %>
        <% if partner_totals[:premium_tokens].to_i.positive? %>
          <p class="currency-total">â­ <%= partner_totals[:premium_tokens] %> Premium Tokens</p>
        <% end %>
      </div>
    </div>

    <% if @preview.warning? %>
      <div class="trade-warnings">
        <p class="warning">âš ï¸ Trade imbalance detected. Double-check the offered currencies and items before confirming.</p>
      </div>
    <% end %>
  </div>

  <div class="trade-actions">
    <% if @trade_session.pending? %>
      <%= button_to "Confirm Trade", trade_session_path(@trade_session, confirm: true), method: :patch, class: "game-btn game-btn--success", data: { confirm: "Are you sure you want to confirm this trade?" } %>
      <%= button_to "Cancel Trade", trade_session_path(@trade_session, cancel: true), method: :patch, class: "game-btn game-btn--danger" %>
    <% elsif @trade_session.confirming? %>
      <p class="waiting-notice">Awaiting final confirmation...</p>
      <%= button_to "Finalize Trade", trade_session_path(@trade_session, confirm: true), method: :patch, class: "game-btn game-btn--success", data: { confirm: "Finalize this trade?" } %>
      <%= button_to "Cancel Trade", trade_session_path(@trade_session, cancel: true), method: :patch, class: "game-btn game-btn--danger" %>
    <% elsif @trade_session.completed? %>
      <p class="trade-complete">âœ… Trade completed successfully!</p>
      <%= link_to "Back to Game", root_path, class: "game-btn" %>
    <% elsif @trade_session.cancelled? %>
      <p class="trade-cancelled">âŒ Trade was cancelled.</p>
      <%= link_to "Back to Game", root_path, class: "game-btn" %>
    <% elsif @trade_session.expired? %>
      <p class="trade-cancelled">âŒ› Trade expired.</p>
      <%= link_to "Back to Game", root_path, class: "game-btn" %>
    <% end %>
  </div>
</div>
